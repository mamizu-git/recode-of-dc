<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>戦績入力</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; max-width: 640px; margin: 2rem auto; padding: 0 1rem; }
  h1 { font-size: 1.25rem; margin-bottom: .5rem; }
  form { display: grid; gap: .75rem; }
  input, select, textarea, button { font-size: 16px; padding: .6rem .7rem; }
  .row { display: grid; grid-template-columns: 1fr; gap: .75rem; }
  .note { color: #666; font-size: .9rem; }
  .ok { color: #0a6; }
  .err { color: #c00; }
  footer { margin-top: 1.25rem; font-size: .85rem; color: #666; }

  .choice-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2列 */
    gap: .5rem;
  }
  .choice-grid label {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: .6rem 1rem;
    border: 1px solid #888;
    border-radius: .4rem;
    cursor: pointer;
  }
  .choice-grid input[type="radio"] { display: none; }
  .choice-grid input[type="radio"]:checked + span {
    background: #0a6;
    color: #fff;
    width: 100%;
    text-align: center;
    border-radius: .4rem;
  }
  button[disabled] { opacity: .5; cursor: not-allowed; }

  /* DP セクション */
  .dp-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: .5rem .75rem;
    align-items: center;
  }
  .dp-grid label { color:#333; font-size:.95rem; }
  .dp-grid .full { grid-column: 1 / -1; }
  .dp-out {
    background: #f7f7f7;
    border: 1px solid #ddd;
    border-radius: .4rem;
    padding: .55rem .7rem;
    min-height: 2.25rem;
</style>

<h1>戦績入力フォーム（<a href="https://docs.google.com/spreadsheets/d/1AS7TdoMZoeTsUyApYJ_THAbuayC-nbkebi3m4wkL2W0" target="_blank">これまでの戦績</a>）</h1>

<form id="match-form">
  <div class="row">
    <input name="player" id="player" placeholder="プレイヤー名" required />
  </div>

  <p>対戦相手のデッキ</p>
  <div class="choice-group">
    <div class="choice-grid" id="opponent-buttons">
      <label><input type="radio" name="opponent" value="ライゼオル"><span>ライゼオル</span></label>
      <label><input type="radio" name="opponent" value="M∀LICE"><span>M∀LICE</span></label>
      <label><input type="radio" name="opponent" value="ジェムナイト"><span>ジェムナイト</span></label>
      <label><input type="radio" name="opponent" value="ジェムナイト(後攻型)"><span>ジェムナイト(後攻型)</span></label>
      <label><input type="radio" name="opponent" value="ティアラメンツ"><span>ティアラメンツ</span></label>
      <label><input type="radio" name="opponent" value="不明"><span>不明</span></label>
      <!-- その他 -->
      <label><input type="radio" name="opponent" value="other"><span>その他</span></label>
      <input type="text" id="opponent-other" placeholder="その他" style="display:none;">
    </div>
    <text id="opponent-other-note" style="color:red; margin-top:.5rem; display:none;">※ 何も入力しなければ「その他」で送信されます</text>
    <!-- その他の自由入力（その他選択時のみ表示／任意入力） -->
  </div>

  <p>結果</p>
  <div class="choice-group">
    <div class="choice-grid" id="result-buttons">
      <label><input type="radio" name="result" value="win"><span>勝ち</span></label>
      <label><input type="radio" name="result" value="lose"><span>負け</span></label>
    </div>
  </div>

  <p>DP</p>
  <div class="dp-grid">
    <label for="dp-base">現在のDP（基準）</label>
    <input type="number" id="dp-base" inputmode="numeric" placeholder="例: 15000" />

    <label for="dp-step">増減幅（1試合）</label>
    <input type="number" id="dp-step" inputmode="numeric" value="1000" />

    <label>推定DP（試合後）</label>
    <div class="dp-out" id="dp-estimated">—</div>

    <label for="dp-actual">実測DP（任意）</label>
    <input type="number" id="dp-actual" inputmode="numeric" placeholder="実測が分かれば入力" />

    <div class="full">
      <span class="note" id="dp-diff-note">※ 実測を入力すると推定との差分を表示します。</span>
    </div>
  </div>

  <button type="submit" id="submit-btn" disabled>送信</button>
  <div id="msg" class="note"></div>
</form>

<footer><span id="env"></span></footer>
<footer><span id="version"></span></footer>

<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxv8mqUirsl4GVgJnDI4qKa8043ufVUqCyLHBqIuuEPNtQgyzM87Epxs3U8D1egYXrthw/exec';
  const API_KEY  = 'afa34o23r510t73ewf3';

  // ?player=Alice で自動入力
  const params = new URLSearchParams(location.search);
  const preset = params.get('player');
  if (preset) document.getElementById('player').value = preset;

  const form        = document.getElementById('match-form');
  const msg         = document.getElementById('msg');
  const submitBtn   = document.getElementById('submit-btn');
  const otherInput  = document.getElementById('opponent-other');
  const dpBaseEl    = document.getElementById('dp-base');
  const dpStepEl    = document.getElementById('dp-step');
  const dpEstEl     = document.getElementById('dp-estimated');
  const dpActualEl  = document.getElementById('dp-actual');
  const dpDiffNote  = document.getElementById('dp-diff-note');

  // localStorage keys
  const keyFor = (player) => `dp:baseline:${player || ''}`;

  // 推定DPを更新
  function updateEstimated() {
    const base = Number(dpBaseEl.value);
    const step = Math.abs(Number(dpStepEl.value || 0));
    const res  = form.querySelector('input[name="result"]:checked')?.value;

    if (Number.isFinite(base) && Number.isFinite(step) && res) {
      const est = base + (res === 'win' ? +step : -step);
      dpEstEl.textContent = String(est);
      // 実測との差分メモ
      const actual = Number(dpActualEl.value);
      if (Number.isFinite(actual)) {
        const diff = actual - est;
        dpDiffNote.textContent = `推定との差分: ${diff > 0 ? '+' : ''}${diff}`;
      } else {
        dpDiffNote.textContent = '※ 実測を入力すると推定との差分を表示します。';
      }
    } else {
      dpEstEl.textContent = '—';
      dpDiffNote.textContent = '※ 実測を入力すると推定との差分を表示します。';
    }
  }

  // 送信ボタン活性/非活性
  function updateSubmitState() {
    const playerFilled    = document.getElementById('player').value.trim().length > 0;
    const opponentChecked = form.querySelector('input[name="opponent"]:checked');
    const resultChecked   = form.querySelector('input[name="result"]:checked');
    submitBtn.disabled = !(playerFilled && opponentChecked && resultChecked);
  }

  // opponent ラジオ
  document.querySelectorAll('input[name="opponent"]').forEach(radio => {
    radio.addEventListener('change', () => {
      if (radio.value === 'other' && radio.checked) {
        otherInput.style.display = 'block';
        otherInput.focus();
      } else if (radio.checked) {
        otherInput.style.display = 'none';
        otherInput.value = '';
      }
      updateSubmitState();
    });
  });

  // result ラジオ
  document.querySelectorAll('input[name="result"]').forEach(radio => {
    radio.addEventListener('change', () => {
      updateSubmitState();
      updateEstimated();
    });
  });

  // プレイヤーが変わったら、その人の基準DPをロード
  function loadBaselineForPlayer() {
    const p = document.getElementById('player').value.trim();
    const saved = localStorage.getItem(keyFor(p));
    if (saved !== null) dpBaseEl.value = saved;
    updateEstimated();
  }

  document.getElementById('player').addEventListener('input', () => {
    updateSubmitState();
    loadBaselineForPlayer();
  });

  // DP関連の入力変更
  [dpBaseEl, dpStepEl, dpActualEl].forEach(el => {
    el.addEventListener('input', updateEstimated);
  });

  // 初期評価
  updateSubmitState();
  loadBaselineForPlayer();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.className = 'note';
    msg.textContent = '送信中...';

    const playerValue = document.getElementById('player').value.trim();

    // opponent value
    const opponentRadio = form.querySelector('input[name="opponent"]:checked');
    const opponentValue = (opponentRadio?.value === 'other')
      ? (otherInput.value.trim() || 'その他')
      : (opponentRadio?.value || '');

    const resultValue = form.querySelector('input[name="result"]:checked')?.value || '';

    const base = Number(dpBaseEl.value);
    const step = Math.abs(Number(dpStepEl.value || 0));
    const est  = (Number.isFinite(base) && Number.isFinite(step) && resultValue)
      ? base + (resultValue === 'win' ? +step : -step)
      : '';

    const actual = dpActualEl.value.trim() === '' ? '' : Number(dpActualEl.value);

    const payload = {
      player   : playerValue,
      opponent : opponentValue,
      result   : resultValue,
      dp_base  : Number.isFinite(base) ? String(base) : '',
      dp_step  : Number.isFinite(step) ? String(step) : '',
      dp_est   : (est === '' ? '' : String(est)),
      dp_actual: (actual === '' ? '' : String(actual)),
      apiKey   : API_KEY,
    };

    try {
      await fetch(ENDPOINT, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams(payload).toString(),
      });

      // 次回の基準DPを更新（実測があれば実測、なければ推定）
      const nextBaseline = (actual !== '' && Number.isFinite(actual))
        ? actual
        : (est !== '' ? est : null);

      if (nextBaseline !== null) {
        localStorage.setItem(keyFor(playerValue), String(nextBaseline));
        dpBaseEl.value = String(nextBaseline); // 画面上も更新
      }

      // 成功とみなし、選択類はリセット（playerとDP基準は保持）
      const keepPlayer = playerValue;
      form.reset();
      document.getElementById('player').value = keepPlayer;
      otherInput.style.display = 'none';
      otherInput.value = '';
      dpActualEl.value = '';
      updateSubmitState();
      updateEstimated();

      msg.className = 'note ok';
      msg.textContent = '記録しました';
    } catch (err) {
      msg.className = 'note err';
      msg.textContent = `通信エラー: ${String(err)}`;
    }
  });

  // デバッグ表示
  document.getElementById('env').textContent = `Origin: ${location.origin}`;
  document.getElementById('version').textContent = `Version: 1.3.0`;
</script>
</html>
