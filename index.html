<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>戦績入力</title>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; max-width: 640px; margin: 2rem auto; padding: 0 1rem; }
  h1 { font-size: 1.25rem; margin-bottom: .5rem; }
  form { display: grid; gap: .75rem; }
  input, select, textarea, button { font-size: 16px; padding: .6rem .7rem; }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
  .note { color: #666; font-size: .9rem; }
  .ok { color: #0a6; }
  .err { color: #c00; }
  footer { margin-top: 1.25rem; font-size: .85rem; color: #666; }
</style>

<h1>戦績入力</h1>
<p class="note">3人チーム向けの簡易入力フォームです。</p>

<form id="match-form">
  <div class="row">
    <input name="player" id="player" placeholder="あなた（Player）" required />
    <input name="opponent" id="opponent" placeholder="対戦相手（Opponent）" required />
  </div>

  <div class="row">
    <select name="result" id="result" required>
      <option value="">結果</option>
      <option value="win">勝ち</option>
      <option value="lose">負け</option>
      <option value="draw">引き分け</option>
    </select>
    <input name="score" id="score" placeholder="スコア（例: 2-1）" />
  </div>

  <textarea name="notes" id="notes" placeholder="メモ" rows="3"></textarea>

  <button type="submit">送信</button>
  <div id="msg" class="note"></div>
</form>

<footer><span id="env"></span></footer>
<footer><span id="version"></span></footer>

<script>
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxv8mqUirsl4GVgJnDI4qKa8043ufVUqCyLHBqIuuEPNtQgyzM87Epxs3U8D1egYXrthw/exec';
  const API_KEY  = 'afa34o23r510t73ewf3';

  // ?player=Alice で自動入力
  const params = new URLSearchParams(location.search);
  const preset = params.get('player');
  if (preset) document.getElementById('player').value = preset;

  document.getElementById('match-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('msg');
    msg.className = 'note'; msg.textContent = '送信中...';

    const payload = {
      player: document.getElementById('player').value.trim(),
      opponent: document.getElementById('opponent').value.trim(),
      result: document.getElementById('result').value,
      score: document.getElementById('score').value.trim(),
      notes: document.getElementById('notes').value.trim(),
      apiKey: API_KEY,
    };

    try {
      const res = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: new URLSearchParams(payload).toString(),
      });
      const data = await res.json();

      if (data.ok) {
        msg.className = 'note ok';
        msg.textContent = `記録しました: ${data.timestamp}`;
        // e.target.reset(); // 送信後にクリアしたい場合は有効化
      } else {
        msg.className = 'note err';
        msg.textContent = `エラー: ${data.error || 'unknown'}`;
      }
    } catch (err) {
      msg.className = 'note err';
      msg.textContent = `通信エラー: ${String(err)}`;
    }
  });

  // デバッグ表示
  document.getElementById('env').textContent = `Origin: ${location.origin}`;
  document.getElementById('version').textContent = `Version: 1.0.1`;
</script>
</html>
